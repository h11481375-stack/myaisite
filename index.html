<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Zoe DIY Studio | æ™ºèƒ½åŠ©æ‰‹</title>
    <style>
        :root { --primary: #ff7e5f; --ai-bg: #2f2f2f; --user-bg: #3c3c3c; --bg: #212121; }
        body, html { height: 100%; margin: 0; font-family: -apple-system, "PingFang SC", sans-serif; background: var(--bg); color: #ececf1; }
        
        /* èŠå¤©å®¹å™¨ */
        #chat-container { display: flex; flex-direction: column; height: 100vh; max-width: 900px; margin: 0 auto; }
        #chat-box { flex: 1; overflow-y: auto; padding: 20px 10px; scroll-behavior: smooth; }
        
        /* æ¶ˆæ¯è¡Œå¸ƒå±€ */
        .message-row { display: flex; width: 100%; margin-bottom: 25px; animation: fadeIn 0.3s ease; }
        .user-row { justify-content: flex-end; }
        .ai-row { justify-content: flex-start; }

        .bubble { max-width: 80%; padding: 12px 18px; border-radius: 20px; font-size: 16px; line-height: 1.6; position: relative; }
        .user-bubble { background: var(--user-bg); color: #fff; border-bottom-right-radius: 4px; }
        .ai-bubble { background: transparent; border: none; padding-left: 0; }
        
        .avatar { width: 36px; height: 36px; border-radius: 4px; margin-right: 15px; display: flex; align-items: center; justify-content: center; font-weight: bold; flex-shrink: 0; }
        .ai-avatar { background: #10a37f; color: white; }

        /* è¾“å…¥åŒº */
        .input-area { padding: 20px; background: transparent; }
        .input-wrapper { display: flex; align-items: center; background: #2f2f2f; border: 1px solid #444; border-radius: 15px; padding: 10px 15px; box-shadow: 0 0 15px rgba(0,0,0,0.2); }
        input { flex: 1; background: none; border: none; color: white; font-size: 16px; outline: none; padding: 5px; }
        
        .icon-btn { background: none; border: none; cursor: pointer; color: #acacbe; font-size: 20px; padding: 5px 10px; transition: 0.2s; }
        .icon-btn:hover { color: var(--primary); }
        .active-mic { color: #ff4b2b; animation: pulse 1s infinite; }

        @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }
        @keyframes pulse { 0% { opacity: 1; } 50% { opacity: 0.5; } 100% { opacity: 1; } }
        
        /* éšè—è®¾ç½® */
        #key-setting { position: fixed; top: 10px; left: 10px; font-size: 10px; color: #444; cursor: pointer; }
    </style>
</head>
<body>

<div id="key-setting" onclick="setKey()">API Key Config</div>

<div id="chat-container">
    <div id="chat-box">
        <div class="message-row ai-row">
            <div class="avatar ai-avatar">Z</div>
            <div class="bubble ai-bubble">ä½ å¥½ï¼æˆ‘æ˜¯ Zoeã€‚æˆ‘å·²ç»åŠ è½½äº†å®Œæ•´çš„ Product.xlsx è‹±æ–‡æ•°æ®åº“ã€‚ä½ å¯ä»¥ç‚¹å‡»ä¸‹æ–¹çš„éº¦å…‹é£ç›´æ¥è·Ÿæˆ‘è¯´è¯ï¼Œæˆ–è€…è¾“å…¥ SKU (å¦‚ FS6807) è¯¢é—®æˆ‘ã€‚</div>
        </div>
    </div>

    <div class="input-area">
        <div class="input-wrapper">
            <button class="icon-btn" id="micBtn" onclick="toggleVoice()">ğŸ¤</button>
            <input type="text" id="userInput" placeholder="å‘é€æ¶ˆæ¯..." autocomplete="off">
            <button class="icon-btn" onclick="handleSend()">ğŸš€</button>
        </div>
    </div>
</div>

<script>
    const chatBox = document.getElementById('chat-box');
    const userInput = document.getElementById('userInput');
    const micBtn = document.getElementById('micBtn');

    // 1. ç®€æ˜“ç‰ˆäº§å“æ•°æ®åº“ (ä»ä½ çš„ Excel æå–)
    const PRODUCT_INFO = "Inventory SKU: FS6807(Ribbon Patch), FS0317(33MM Butterfly), FS5378(Lotus Alloy), FS5290(Nine-Hole Patch), FS5932(Clear Beads), FS10221(Zootopia Stickers), FS10184(Tulip Flower), FS10196(Sanrio Stickers). All products are for DIY crafts.";

    // 2. è¯­éŸ³è¯†åˆ« (Speech to Text)
    const SpeechRecognition = window.SpeechRecognition || window.webkitSpeechRecognition;
    let recognition;
    if (SpeechRecognition) {
        recognition = new SpeechRecognition();
        recognition.lang = 'zh-CN';
        recognition.onresult = (event) => {
            const transcript = event.results[0][0].transcript;
            userInput.value = transcript;
            toggleVoice(); // åœæ­¢å½•éŸ³
            handleSend(); // è‡ªåŠ¨å‘é€
        };
    }

    function toggleVoice() {
        if (!recognition) { alert("æ‚¨çš„æµè§ˆå™¨ä¸æ”¯æŒè¯­éŸ³è¯†åˆ«"); return; }
        micBtn.classList.toggle('active-mic');
        if (micBtn.classList.contains('active-mic')) {
            recognition.start();
        } else {
            recognition.stop();
        }
    }

    // 3. è¯­éŸ³æœ—è¯» (Text to Speech)
    function speak(text) {
        const msg = new SpeechSynthesisUtterance();
        msg.text = text;
        msg.lang = 'zh-CN';
        window.speechSynthesis.speak(msg);
    }

    function setKey() {
        const key = prompt("è¾“å…¥æ™ºè°± API Key:");
        if(key) localStorage.setItem('zhipu_key', key);
    }

    async function handleSend() {
        const text = userInput.value.trim();
        const apiKey = localStorage.getItem('zhipu_key');
        if (!text || !apiKey) { if(!apiKey) setKey(); return; }

        addMessage(text, 'user');
        userInput.value = '';
        const aiRow = addMessage("Zoe æ­£åœ¨æ€è€ƒ...", 'ai');

        try {
            const response = await fetch("https://open.bigmodel.cn/api/paas/v4/chat/completions", {
                method: "POST",
                headers: { "Content-Type": "application/json", "Authorization": `Bearer ${apiKey}` },
                body: JSON.stringify({
                    model: "glm-4",
                    messages: [
                        { role: "system", content: "ä½ æ˜¯ä¸€ä½ä¸“ä¸šDIYä¸“å®¶Zoeã€‚ä½ æ‹¥æœ‰è¿™äº›äº§å“æ•°æ®ï¼š" + PRODUCT_INFO + "ã€‚è¯·ç”¨äº²åˆ‡çš„ä¸­æ–‡å›ç­”ã€‚å›ç­”ç»“æŸåï¼Œè¯·ç®€çŸ­æœ‰åŠ›ã€‚" },
                        { role: "user", content: text }
                    ]
                })
            });
            const data = await response.json();
            const reply = data.choices[0].message.content;
            aiRow.innerText = reply;
            // è‡ªåŠ¨æœ—è¯»å›å¤
            speak(reply);
        } catch (e) {
            aiRow.innerText = "æŠ±æ­‰ï¼Œå‡ºé”™äº†ã€‚";
        }
    }

    function addMessage(text, role) {
        const isAi = role === 'ai';
        const row = document.createElement('div');
        row.className = `message-row ${isAi ? 'ai-row' : 'user-row'}`;
        
        const avatarHtml = isAi ? '<div class="avatar ai-avatar">Z</div>' : '';
        const bubbleHtml = `<div class="bubble ${isAi ? 'ai-bubble' : 'user-bubble'}">${text}</div>`;
        
        row.innerHTML = avatarHtml + bubbleHtml;
        chatBox.appendChild(row);
        chatBox.scrollTop = chatBox.scrollHeight;
        return row.querySelector('.bubble');
    }

    userInput.addEventListener('keypress', (e) => { if(e.key === 'Enter') handleSend(); });
</script>
</body>
</html>
