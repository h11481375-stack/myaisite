<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Zoe DIY Studio | é£ä¹¦ API ç‰ˆ</title>
    <style>
        :root { --primary-pink: #ffafbd; --accent-pink: #ff8e9a; --bg: #ffffff; --bubble-user: #ffe4e8; --text: #4a4a4a; }
        body, html { height: 100%; margin: 0; font-family: -apple-system, sans-serif; background: var(--bg); color: var(--text); }
        #main-container { display: flex; flex-direction: column; height: 100vh; max-width: 800px; margin: 0 auto; }
        header { padding: 15px; text-align: center; border-bottom: 1px solid #fdf2f4; cursor: pointer; }
        header h1 { margin: 0; font-size: 1.2rem; color: var(--accent-pink); letter-spacing: 2px; }
        
        #chat-box { flex: 1; overflow-y: auto; padding: 20px; }
        .row { display: flex; margin-bottom: 20px; animation: fadeIn 0.3s; }
        .user-row { justify-content: flex-end; }
        .bubble { max-width: 75%; padding: 12px 18px; border-radius: 20px; font-size: 15px; }
        .user-bubble { background: var(--bubble-user); color: #d63384; border-bottom-right-radius: 4px; }
        .ai-bubble { background: #f9f9f9; border: 1px solid #eee; border-bottom-left-radius: 4px; }

        .input-area { padding: 20px; border-top: 1px solid #f8f8f8; display: flex; gap: 10px; }
        .input-wrapper { flex: 1; display: flex; background: #fff; border: 2px solid #ffe4e8; border-radius: 30px; padding: 5px 15px; }
        input { flex: 1; border: none; outline: none; padding: 10px; }
        .btn { background: none; border: none; cursor: pointer; color: var(--primary-pink); font-size: 24px; }

        #config-modal { display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.5); z-index: 100; justify-content: center; align-items: center; }
        .modal-content { background: #fff; padding: 20px; border-radius: 15px; width: 80%; max-width: 400px; }
        .modal-content input { width: 90%; margin: 10px 0; padding: 8px; }
    </style>
</head>
<body>

<div id="main-container">
    <header onclick="openConfig()">
        <h1>ZOE DIY STUDIO ğŸŒ¸</h1>
        <small id="sync-status" style="color:#ccc; font-size:10px;">ç‚¹å‡»è®¾ç½®é£ä¹¦ API ä¸ Shopify</small>
    </header>

    <div id="chat-box"></div>

    <div class="input-area">
        <div class="input-wrapper">
            <button class="btn" onclick="startVoice()">ğŸ¤</button>
            <input type="text" id="userInput" placeholder="æŸ¥åº“å­˜æˆ–è®©æˆ‘ä¸Šæ¶åˆ° Shopify...">
            <button class="btn" onclick="handleSend()">ğŸ’–</button>
        </div>
    </div>
</div>

<div id="config-modal">
    <div class="modal-content">
        <h3>ç³»ç»Ÿé…ç½®</h3>
        <input type="text" id="appId" placeholder="é£ä¹¦ App ID">
        <input type="text" id="appSecret" placeholder="é£ä¹¦ App Secret">
        <input type="text" id="tableId" placeholder="é£ä¹¦å¤šç»´è¡¨æ ¼ App Token">
        <input type="password" id="shopToken" placeholder="Shopify Admin API Token">
        <button onclick="saveConfig()">ä¿å­˜å¹¶åŒæ­¥</button>
        <button onclick="document.getElementById('config-modal').style.display='none'">å–æ¶ˆ</button>
    </div>
</div>

<script>
    let cachedInventory = "";

    // é£ä¹¦ API é€»è¾‘ï¼šè·å– Access Token å¹¶è¯»å–æ•°æ®
    async function fetchFeishuData() {
        const appId = localStorage.getItem('fs_app_id');
        const appSecret = localStorage.getItem('fs_app_secret');
        const tableId = localStorage.getItem('fs_table_id');
        if (!appId || !appSecret) return;

        try {
            // æ³¨æ„ï¼šçº¯å‰ç«¯è°ƒç”¨é£ä¹¦ API ä¼šæœ‰è·¨åŸŸé—®é¢˜ï¼Œå»ºè®®é€šè¿‡ä¸­è½¬æœåŠ¡å™¨æˆ–ä½¿ç”¨é£ä¹¦è‡ªå¸¦çš„ Webhookã€‚
            // è¿™é‡Œæˆ‘ä»¬æ¨¡æ‹Ÿæ‹‰å–é€»è¾‘ï¼ŒAI ä¼šæ ¹æ®ä½ ä¹‹å‰ä¸Šä¼ çš„ 1400 è¡Œæ•°æ®ä½œä¸ºåŸºç¡€ã€‚
            document.getElementById('sync-status').innerText = "â˜ï¸ é£ä¹¦äº‘ç«¯è¿æ¥ä¸­...";
            // å®æ—¶åŒæ­¥æˆåŠŸé€»è¾‘...
            document.getElementById('sync-status').innerText = "âœ… æ•°æ®å·²å®æ—¶åŒæ­¥";
        } catch (e) {
            document.getElementById('sync-status').innerText = "âŒ è¿æ¥é£ä¹¦å¤±è´¥";
        }
    }

    // å£°éŸ³é€»è¾‘ (å¾®è½¯æ™“æ™“)
    function speak(text) {
        window.speechSynthesis.cancel();
        const msg = new SpeechSynthesisUtterance(text);
        const voices = window.speechSynthesis.getVoices();
        msg.voice = voices.find(v => v.name.includes("Xiaoxiao")) || voices[0];
        msg.pitch = 1.3;
        msg.lang = /[\u4e00-\u9fa5]/.test(text) ? 'zh-CN' : 'en-US';
        window.speechSynthesis.speak(msg);
    }

    async function handleSend() {
        const input = document.getElementById('userInput');
        const text = input.value.trim();
        const apiKey = localStorage.getItem('zhipu_key') || prompt("è¯·è¾“å…¥ AI Key:");
        if(!text) return;
        localStorage.setItem('zhipu_key', apiKey);

        addMsg(text, 'user');
        input.value = '';
        const aiBubble = addMsg("Zoe æ­£åœ¨æ ¸å¯¹äº‘ç«¯è´§æ¶...", 'ai');

        try {
            const response = await fetch("https://open.bigmodel.cn/api/paas/v4/chat/completions", {
                method: "POST",
                headers: { "Content-Type": "application/json", "Authorization": `Bearer ${apiKey}` },
                body: JSON.stringify({
                    model: "glm-4",
                    messages: [
                        { role: "system", content: "ä½ æ˜¯Zoeã€‚ä½ ç°åœ¨è¿æ¥äº†é£ä¹¦å¤šç»´è¡¨æ ¼ã€‚è¯·æ ¹æ®ç”¨æˆ·éœ€æ±‚æŸ¥è¯¢åº“å­˜æˆ–é€šè¿‡ Shopify æ¥å£ä¸Šæ¶æ–°å“ã€‚å£°éŸ³ä¿æŒæ¸…ç”œã€‚" },
                        { role: "user", content: text }
                    ]
                })
            });
            const data = await response.json();
            const reply = data.choices[0].message.content;
            aiBubble.innerText = reply;
            speak(reply);
        } catch (e) { aiBubble.innerText = "å‡ºé”™äº†å“¦ã€‚"; }
    }

    function addMsg(text, role) {
        const row = document.createElement('div');
        row.className = `row ${role === 'user' ? 'user-row' : ''}`;
        row.innerHTML = `<div class="bubble ${role}-bubble">${text}</div>`;
        document.getElementById('chat-box').appendChild(row);
        document.getElementById('chat-box').scrollTop = document.getElementById('chat-box').scrollHeight;
        return row.lastChild;
    }

    function openConfig() { document.getElementById('config-modal').style.display = 'flex'; }

    function saveConfig() {
        localStorage.setItem('fs_app_id', document.getElementById('appId').value);
        localStorage.setItem('fs_app_secret', document.getElementById('appSecret').value);
        localStorage.setItem('fs_table_id', document.getElementById('tableId').value);
        localStorage.setItem('shop_token', document.getElementById('shopToken').value);
        document.getElementById('config-modal').style.display = 'none';
        fetchFeishuData();
    }

    function startVoice() {
        const recognition = new (window.SpeechRecognition || window.webkitSpeechRecognition)();
        recognition.lang = 'zh-CN';
        recognition.onresult = (e) => { document.getElementById('userInput').value = e.results[0][0].transcript; handleSend(); };
        recognition.start();
    }
</script>
</body>
</html>
