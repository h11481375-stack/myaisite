<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Zoe DIY Studio | é£ä¹¦åº“å­˜åŠ©æ‰‹</title>
    <style>
        :root { --primary-pink: #ffafbd; --accent-pink: #ff8e9a; --bg: #ffffff; --bubble-user: #ffe4e8; --text: #4a4a4a; }
        body, html { height: 100%; margin: 0; font-family: -apple-system, sans-serif; background: var(--bg); color: var(--text); }
        #main-container { display: flex; flex-direction: column; height: 100vh; max-width: 800px; margin: 0 auto; box-shadow: 0 0 15px rgba(0,0,0,0.05); }
        header { padding: 15px; text-align: center; background: #fff; border-bottom: 1px solid #fdf2f4; cursor: pointer; }
        header h1 { margin: 0; font-size: 1.2rem; color: var(--accent-pink); letter-spacing: 2px; }
        #sync-status { font-size: 10px; color: #ccc; margin-top: 5px; display: block; }
        #config-panel { display: none; background: #fff5f6; padding: 15px; border-bottom: 1px solid #ffe4e8; }
        #config-panel input { padding: 8px; margin: 5px 0; border: 1px solid #ffafbd; border-radius: 20px; width: 100%; box-sizing: border-box; outline: none; }
        .save-btn { background: var(--accent-pink); color: white; border: none; padding: 10px; border-radius: 20px; cursor: pointer; margin-top: 10px; width: 100%; }
        #chat-box { flex: 1; overflow-y: auto; padding: 20px; background: #fff; }
        .row { display: flex; margin-bottom: 20px; animation: fadeIn 0.3s ease; }
        .user-row { justify-content: flex-end; }
        .avatar { width: 35px; height: 35px; border-radius: 50%; background: var(--primary-pink); color: white; display: flex; align-items: center; justify-content: center; margin-right: 10px; font-weight: bold; flex-shrink: 0; }
        .bubble { max-width: 75%; padding: 12px 18px; border-radius: 20px; font-size: 15px; line-height: 1.6; }
        .user-bubble { background: var(--bubble-user); color: #d63384; border-bottom-right-radius: 4px; }
        .ai-bubble { background: #f9f9f9; border: 1px solid #eee; border-bottom-left-radius: 4px; }
        .input-area { padding: 20px; background: #fff; border-top: 1px solid #f8f8f8; display: flex; gap: 10px; }
        .input-wrapper { flex: 1; display: flex; border: 2px solid #ffe4e8; border-radius: 30px; padding: 5px 15px; }
        input[type="text"] { flex: 1; border: none; outline: none; padding: 10px; font-size: 16px; }
        .btn { background: none; border: none; cursor: pointer; color: var(--primary-pink); font-size: 24px; }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } }
    </style>
</head>
<body>

<div id="main-container">
    <header onclick="toggleConfig()">
        <h1>ZOE DIY STUDIO ğŸŒ¸</h1>
        <span id="sync-status">ç‚¹å‡»æ­¤å¤„é…ç½® AI Key å’Œé£ä¹¦</span>
    </header>

    <div id="config-panel">
        <strong>ç³»ç»Ÿæ ¸å¿ƒé…ç½®:</strong>
        <input type="password" id="apiKey" placeholder="æ™ºè°± AI Key (å¿…å¡«)">
        <input type="text" id="appId" placeholder="é£ä¹¦ App ID">
        <input type="text" id="appSecret" placeholder="é£ä¹¦ App Secret">
        <input type="text" id="appToken" placeholder="é£ä¹¦è¡¨æ ¼ ID (bas... æˆ– sht...)">
        <button class="save-btn" onclick="saveConfig()">ä¿å­˜é…ç½®</button>
    </div>

    <div id="chat-box">
        <div class="row ai-row">
            <div class="avatar">Z</div>
            <div class="bubble ai-bubble">åº—é•¿å¥½ï¼è¯·å…ˆç‚¹å‡»ä¸Šæ–¹æ ‡é¢˜ï¼Œå¡«å…¥ä½ çš„ AI Key å’Œé£ä¹¦ä¿¡æ¯ã€‚æˆ‘ä¼šä¹–ä¹–åœ¨è¿™é‡Œç­‰ä½ çš„æŒ‡ä»¤å–”ï¼âœ¨</div>
        </div>
    </div>

    <div class="input-area">
        <div class="input-wrapper">
            <button class="btn" onclick="startVoice()">ğŸ¤</button>
            <input type="text" id="userInput" placeholder="æŸ¥ä¸ªåº“å­˜è¯•è¯•ï¼Ÿ" onkeypress="if(event.keyCode==13) handleSend()">
            <button class="btn" onclick="handleSend()">ğŸ’–</button>
        </div>
    </div>
</div>

<script>
    // è¯­éŸ³åˆæˆ
    function speak(text) {
        window.speechSynthesis.cancel();
        const msg = new SpeechSynthesisUtterance(text);
        const voices = window.speechSynthesis.getVoices();
        msg.voice = voices.find(v => v.name.includes("Xiaoxiao")) || voices[0];
        msg.pitch = 1.35;
        msg.lang = 'zh-CN';
        window.speechSynthesis.speak(msg);
    }

    // æ ¸å¿ƒå‘é€é€»è¾‘
    async function handleSend() {
        const input = document.getElementById('userInput');
        const text = input.value.trim();
        const apiKey = localStorage.getItem('zhipu_key');
        
        if(!apiKey) {
            alert("è¯·ç‚¹å‡»ä¸Šæ–¹æ ‡é¢˜è¾“å…¥ AI Key å–”ï¼");
            toggleConfig();
            return;
        }
        if(!text) return;

        addMsg(text, 'user');
        input.value = '';
        const aiBubble = addMsg("Zoe æ­£åœ¨ç¿»çœ‹é£ä¹¦è´¦æœ¬...", 'ai');

        try {
            const response = await fetch("https://open.bigmodel.cn/api/paas/v4/chat/completions", {
                method: "POST",
                headers: { "Content-Type": "application/json", "Authorization": `Bearer ${apiKey}` },
                body: JSON.stringify({
                    model: "glm-4",
                    messages: [
                        { role: "system", content: "ä½ æ˜¯Zoeã€‚ä½ å·²è¿æ¥é£ä¹¦ã€‚è¯·æ ¹æ®è¡¨æ ¼å†…å®¹ç”œç¾åœ°å›ç­”åº“å­˜ã€‚å¦‚æœä½ æ²¡æ‹¿åˆ°æ•°æ®ï¼Œè¯·æé†’åº—é•¿æ£€æŸ¥é£ä¹¦æœºå™¨äººæ˜¯å¦æ·»åŠ ã€‚" },
                        { role: "user", content: text }
                    ]
                })
            });
            const data = await response.json();
            const reply = data.choices[0].message.content;
            aiBubble.innerText = reply;
            speak(reply);
        } catch (e) { 
            aiBubble.innerText = "å‡ºé”™äº†ï¼Œå¯èƒ½æ˜¯ Key æ²¡å¡«å¯¹æˆ–è€…ç½‘ç»œé—¹è„¾æ°”äº†ã€‚"; 
        }
    }

    function addMsg(text, role) {
        const isAi = role === 'ai';
        const row = document.createElement('div');
        row.className = `row ${isAi ? 'ai-row' : 'user-row'}`;
        row.innerHTML = isAi ? `<div class="avatar">Z</div><div class="bubble ai-bubble">${text}</div>` : `<div class="bubble user-bubble">${text}</div>`;
        document.getElementById('chat-box').appendChild(row);
        document.getElementById('chat-box').scrollTop = document.getElementById('chat-box').scrollHeight;
        return row.querySelector('.bubble');
    }

    function toggleConfig() {
        const p = document.getElementById('config-panel');
        p.style.display = p.style.display === 'block' ? 'none' : 'block';
        // è‡ªåŠ¨å¡«å…¥å·²å­˜çš„å€¼
        document.getElementById('apiKey').value = localStorage.getItem('zhipu_key') || '';
        document.getElementById('appId').value = localStorage.getItem('fs_app_id') || '';
        document.getElementById('appSecret').value = localStorage.getItem('fs_app_secret') || '';
        document.getElementById('appToken').value = localStorage.getItem('fs_app_token') || '';
    }

    function saveConfig() {
        localStorage.setItem('zhipu_key', document.getElementById('apiKey').value);
        localStorage.setItem('fs_app_id', document.getElementById('appId').value);
        localStorage.setItem('fs_app_secret', document.getElementById('appSecret').value);
        localStorage.setItem('fs_app_token', document.getElementById('appToken').value);
        alert("é…ç½®ä¿å­˜æˆåŠŸï¼ğŸŒ¸");
        toggleConfig();
    }

    function startVoice() {
        const recognition = new (window.SpeechRecognition || window.webkitSpeechRecognition)();
        recognition.lang = 'zh-CN';
        recognition.onresult = (e) => { document.getElementById('userInput').value = e.results[0][0].transcript; handleSend(); };
        recognition.start();
    }
</script>
</body>
</html>
